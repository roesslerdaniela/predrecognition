---
title: "Data Analysis - Manually-Scored Data (BORIS)"
author: "Daniela C. Rößler, Massimo De Agrò, Kris Kim, Paul S. Shamble"
output: pdf_document
---
# Data analysis - Predator recognition - hand-scored data using BORIS

```{r include = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

## Load packages

```{r packages}
library(car) #for anova
library(glmmTMB) #for mixed models
library(DHARMa) #for residual distribution check
library(ggplot2) #for plotting
library(emmeans) #for post-hoc
library(fitdistrplus) #for data distribution
library(dplyr) #for stats
library(lsmeans) #compare slopes
library(svglite) #create svg files
```
## Load data

```{r loading}
master <- read.csv("C:/Users/roess/Desktop/Publications/PredRecognition/Supplements/borisdata.csv")

master$trial <- as.factor(master$trial)
master$day <- as.factor(master$day)
master$subject <- as.factor(master$subject)

#divide by experiment
exp1 <- subset(master, master$exp == 1)
exp2 <- subset(master, master$exp == 2)
```

## Experiment 1 - blob vs blobeyes vs shiny vs marp vs phid

In experiment 1, spiders were tested using 5 different objects (Blob = control, BlobEyes = control + eyes, Marp = Marpissa, Phid = Phidippus, Shiny = 3D model).

### Preliminary analysis

 All the preliminary analyses will use passing as dependent variable as we consider it to be the more robust and objective measure of recognition of the target. we are going to test all variables against passing regardless of condition.

#### Sex differences

```{r model_sex}
msex <- glmmTMB(passing ~ condition * sex + (1|subject), data = exp1, family=binomial)
simres <- simulateResiduals(msex)
plot(simres)
Anova(msex)
```
The model is correctly distributed. Since the test is based on the y, we will not repeat the distribution test for every other model that uses passing as dependent variable. There is no differences between sexes.

#### Day

We are going to check whether there was any effect between the two different test days.

```{r model_day}
mday <- glmmTMB(passing ~ condition * day + (1|subject), data=exp1, family = binomial)
Anova(mday)
```

#### Date

We are going to check whether the behavior was balanced over the different dates at which spiders were tested.

```{r model_date}
mdate <- glmmTMB(passing~date + (1|subject), data=exp1, family = binomial)
Anova(mdate)
```
There is a difference between dates, thus we are going to do a post-hoc test.

```{r posthoc_date_exp1}
e <- emmeans(mdate, ~date, type= "response")
pairs(e, adjust='bonferroni')
```
It seems like the 23 of april is different in terms of retreat amount from the 17 and the 21. We will plot the data to visualize it.

```{r plot_date_exp1}
toplotdate <- as.data.frame(e)
ggplot(toplotdate, aes(x=date, y=prob))+
geom_point()+
geom_errorbar(aes(ymin=prob-SE,ymax=prob+SE))+
ylim(0,1)+
ggtitle("Probability of passing per date")
```
It appears that the difference is significant against day 17th and 21st. The 23rd has a lower percentage of retreats in general. It just so happens that days 17 and 21 are the highest, so that the difference only remains there. In general, this difference should not be concerning, since the conditions are balanced over all dates.

### Main analysis

#### Passing the target

We are now testing the potential effect of condition and order of object presentation on the probability to pass the object. We use subject as a random factor.

```{r model_pass_exp1}
mpass <- glmmTMB(passing~condition * test * day + (1|subject), data= exp1, family= binomial)
simres <- simulateResiduals(mpass)
plot(simres)
Anova(mpass)
```
The distribution is correct. We see a significant effect of condition as well as an effect in the interaction of condition and presentation order. We will do a post-hoc test to see the differences in conditions. The post-hoc will not contain test since is a continuous variable and cannot be inserted in estimated mean analysis.

```{r posthoc_pass_exp1}
toplotpass <- emmeans(mpass, ~condition, type="response")
pairs(toplotpass, adjust = 'bonferroni')
```
All pairwise comparisons are significant except for Marpissa and Shiny as well as Phidippus and Shiny, also Blob and Shiny are not significant which can only be explained by a complete data separation (no spider ever passed this condition). We will plot the model:

```{r plot_pass_exp1}
toplotpass <- as.data.frame(toplotpass)
ggplot(toplotpass, aes(condition, prob, color= condition))+
geom_point(cex = 4)+
geom_errorbar(aes(ymin=prob-SE,ymax=prob+SE), cex = 1, width= .8)+
ylim(0,1)+
labs(title = "Probability to pass", y= "probability")+
  scale_x_discrete(labels = c("control", "control + eyes",
                              "Marpissa", "Phidippus", "3D model"))+
theme(axis.title.x = element_blank(), axis.text.x = element_text(size=10, angle=45, hjust = 1),
      axis.text.y = element_text(size=10), axis.title.y = element_text(size=10),
      plot.title = element_text(size= 15, face= "bold"), legend.position = "none")+
ggsave(filename = "pass_boris.svg", width = 8, height = 10)
```
We can clearly see that virtually no spider ever passed the 3D model (Shiny), however, the probability to pass the control lies around 80%. The probability to pass the control with eyes only lies around 55%, which is significantly less than the control. Due to the interaction effect we saw in the model, we will now plot this probability depending on presentation order:

```{r plot_pass_testorder_exp1}
new.labels2 <- c("Blob" = "control", "BlobEyes" = "control + eyes",
                 "Marp" = "Marpissa", "Phid"= "Phidippus", "Shiny" = "3D model")

ggplot(exp1, aes(x=test,y=passing, color= condition))+
  facet_grid(~condition, labeller = labeller(condition = new.labels2))+
geom_jitter(width = 0, height = 0.02,shape = 1, size=2)+
geom_smooth(method="glm")+
ylim(-0.2,1.2)+
labs(title = "Probability to pass depending on order of presentation",
     x= "order of presentation", size= 12, y= "probability", size = 12)+
theme(strip.text = element_text(size=10), axis.text.x = element_text(size=10),
      axis.text.y = element_text(size=10), axis.title.x = element_text(size=10),
      axis.title.y = element_text(size=10), plot.title = element_text(size= 15, face= "bold"),
      legend.position = "none")
```
We can see that the effect likely stems from the Blobeye condition, showing that passing probability increases significantly with the number of tests for this condition. Next, we will examine the interaction effect of condition and test by analysing the slopes for each condition and using post-hoc correction

```{r posthoc_passing_slopes}
mlst <- lstrends(mpass, "condition", var= "test")
test(mlst, adjust= "bonferroni")
```
As expected the effect comes from the control + eyes condition.

#### Retreat

Retreats (meaning moving away from the object after freezing) was observable in the videos. It is a proxy of recognition. We noticed that when detecting a threatening object, spiders freeze and subsequently retreat. Using retreat probability as predicted by condition we can infer the presence of detection.

The model will contain:

* condition, as is obvious
* test, which indicates the order in which the objects are presented within an experiment
* day, the test day, either 1 or 2

```{r model_retreat_exp1}
mret <-glmmTMB(retreat~condition * test * day + (1|subject), data = exp1, family=binomial)
Anova(mret)
```
There is a strong effect of condition, meaning that spiders retreat differently for different objects. There is also an effect of the interaction between condition and test, meaning that the retreat probability changes with time (or presentation order) but only for one or some conditions; or alternatively, the change in probability with the passage of time changes direction with condition
 To better see the effect, we will do a post-hoc test to see the differences in conditions. The post-hoc will not contain test since is a continuous variable and cannot be inserted in estimated mean analysis. Lastly, we will plot the probability of retreat for each condition.

```{r posthoc_retreat_exp1}
e <- emmeans(mret,~condition, type = "response")
pairs(e, adjust = 'bonferroni')
```
Here we see:
* all objects have a significantly higher retreat probability than Blob
* all objects but Blob have a significantly higher retreat probability than Blob with eyes
* both Phid and Shiny have a higher retreat probability than Marp.
* There is no difference between Phid and Shiny

Next, we will examine the interaction effect of condition and test by analysing the slopes for each condition and using post-hoc correction

```{r posthoc_retreat_slopes}
mlst <- lstrends(mret, "condition", var= "test")
test(mlst, adjust= "bonferroni")
```
We will now produce two plots: one showing just the differences in conditions, and one highlighting the presentation order effect.

```{r plot_retreat_exp1}
toplotret <- as.data.frame(e)
ggplot(toplotret, aes(x=condition,y=prob, color= condition))+
geom_point(cex = 4)+
geom_errorbar(aes(ymin=prob-SE,ymax=prob+SE), cex = 1, width= .8)+
ylim(0,1)+
labs(title = "Probability to retreat", y= "probability")+
  scale_x_discrete(labels = c("control", "control + eyes", "Marpissa",
                              "Phidippus", "3D model"))+
theme(axis.title.x = element_blank(), axis.text.x = element_text(size=10, angle=45, hjust = 1),
      axis.text.y = element_text(size=10), axis.title.y = element_text(size=10),
      plot.title = element_text(size= 15, face= "bold"), legend.position = "none")

ggsave("toplotret.svg")
```

```{r plot_retreat_testorder_exp1}
new.labels <- c("Blob" = "control", "BlobEyes" = "control + eyes",
                "Marp" = "Marpissa", "Phid"= "Phidippus", "Shiny" = "3D model")

ggplot(exp1, aes(x=test,y=retreat,color=condition))+
facet_grid(~condition, labeller = labeller(condition = new.labels))+
geom_jitter(width = 0.1, height = 0.05, shape=1, size=3)+
geom_smooth(method="glm")+
ylim(-0.1,1.2)+
labs(title = "Probability to retreat depending on order of presentation",
     x= "order of presentation", size= 12, y= "probability", size = 12)+
theme(strip.text = element_text(size=10), axis.text.x = element_text(size=10),
      axis.text.y = element_text(size=10), axis.title.x = element_text(size=10),
      axis.title.y = element_text(size=10), plot.title = element_text(size= 15, face= "bold"),
      legend.position = "none")

ggsave("exp1.svg")

```
We can see that retreat supports the same findings as the variable "passing" which we assume to be more robust and less subjective.

#### Jump

We expect jump to be in line with the earlier analyses. For completeness we will follow the same steps for this variable.

```{r model_jump_exp1}
mj <- glmmTMB(jump~condition * test * day +(1|subject), data = exp1, family = binomial)
simres <- simulateResiduals(mj)
plot(simres)
Anova(mj)
```
The distribution is correct. The effect remains the same as before. We now do a post-hoc test.

```{r posthoc_jump_exp1}
e <- emmeans(mj,~condition, type="response")
pairs(e, adjust = 'bonferroni')
```
The results look the same. We will generate the two plots for completeness (probability and order of presentation).

```{r plot_jump_exp1}
toplotj <- as.data.frame(e)
ggplot(toplotj, aes(x=condition,y=prob, color=condition))+
geom_point(cex = 3)+
geom_errorbar(aes(ymin=prob-SE,ymax=prob+SE), cex = 1.4, width= .8)+
ylim(0,1)+
labs(title = "Probability to jump", y= "probability")+
  scale_x_discrete(labels = c("control", "control + eyes",
                              "Marpissa", "Phidippus", "3D model"))+
theme(axis.title.x = element_blank(), axis.text.x = element_text(size=10),
      axis.text.y = element_text(size=10), axis.title.y = element_text(size=10),
      plot.title = element_text(size= 15, face= "bold"), legend.position = "none")
```
The plot looks almost identical to the probability to pass the object. However, Phidippus and the 3D model show slightly higher probabilities to jump compared to the probability to pass the object, most likely because spiders sometimes jump across the gap before looking at the object.

```{r plot_jump_testorder_exp1}
new.labels3 <- c("Blob" = "control", "BlobEyes" = "control + eyes",
                 "Marp" = "Marpissa", "Phid"= "Phidippus", "Shiny" = "3D model")

ggplot(exp1, aes(x=test,y=jump,color=condition))+
facet_grid(~condition, labeller = labeller(condition = new.labels3))+
geom_jitter(width = 0.1, height = 0.05, shape=1, size=2)+
geom_smooth(method="glm")+
ylim(-0.1,1.2)+
labs(title = "Probability to jump depending on order of presentation",
     x= "order of presentation", size= 12, y= "probability", size = 12)+
theme(strip.text = element_text(size=10), axis.text.x = element_text(size=10),
      axis.text.y = element_text(size=10), axis.title.x = element_text(size=10),
      axis.title.y = element_text(size=10), plot.title = element_text(size= 15, face= "bold"),
      legend.position = "none")
```
We see the same effect as with passing. The probability of jumping is inversely correlated to the probability of retreating and there is an obvious effect of presentation order for the control + eyes condition.

#### Freeze duration (reaction time)

Freeze duration is a proxy of reaction time. It entails the detection, integration and decision making process until the behavioral response. We use this as a proxy of ease of recognition and potential certainty about the objects threat value. We will explore reactiontime for all five conditions. Attention: reactiontime is only present for trials in which spiders froze, thus the number of datapoints varies between conditions.

```{r model_reactiontime_exp1}
mreac <- glmmTMB(reactiontime ~ condition * test * day + (1|subject), family= gaussian, data= exp1)
simres <- simulateResiduals(mreac)
plot(simres)
```
The distribution is not correct. We now check for the right distribution:

```{r distributioncheck_reactiontime_exp1}
plotdist(exp1$reactiontime[!is.na(exp1$reactiontime)], histo = TRUE, demp = TRUE)
descdist(exp1$reactiontime[!is.na(exp1$reactiontime)], boot = 1000)
lw <- fitdist(exp1$reactiontime[!is.na(exp1$reactiontime)], "weibull")
lg <- fitdist(exp1$reactiontime[!is.na(exp1$reactiontime)], "gamma")
lln <- fitdist(exp1$reactiontime[!is.na(exp1$reactiontime)], "lnorm")

denscomp(list(lw, lg, lln))
```
None of the distributions fit our data exactly, the most similar seems to be the lognormal, however is not a perfect fit. The best candidate seem to be Gamma. We will try to calculate the model with Gamma distrubtion.

```{r model_reactiontime_exp1_distr_gamma}
mreac <- glmmTMB(reactiontime ~ condition + (1|subject), family= Gamma, data= exp1)
```
No model seem to be working. We have tried a lot pof different ways of getting this to converge but without any luck.
As a last resort we will drop the random effect. We know that this is not ideal, but there seems to be no other way to get any results. We advise caution in interpreting these results.

```{r model_reactiontime_exp1_drop_random}
mreac <- glm(reactiontime ~ condition * test * day, family= Gamma, data= exp1)
simres <- simulateResiduals(mreac)
plot(simres)
Anova(mreac)
```
We found an effect of condition and an interaction effect of condition and day. We now do a post-hoc test:

```{r posthoc_reactiontime_exp1}
e <- emmeans(mreac, ~condition*day)
contrast(e, list(Blob1vs2 = c(1,0,0,0,0,-1,0,0,0,0),
                 BlobEyes1vs2 = c(0,1,0,0,0,0,-1,0,0,0),
                 Marp1vs2 = c(0,0,1,0,0,0,0,-1,0,0),
                 Phid1vs2 = c(0,0,0,1,0,0,0,0,-1,0),
                 Shiny1vs2 = c(0,0,0,0,1,0,0,0,0,-1),
                 BlobVsBlobEyes = c(0.5,-0.5,0,0,0,0.5,-0.5,0,0,0),
                 BlobVsMarp = c(0.5,0,-0.5,0,0,0.5,0,-0.5,0,0),
                 BlobVsPhid = c(0.5,0,0,-0.5,0,0.5,0,0,-0.5,0),
                 BlobVsShiny = c(0.5,0,0,0,-0.5,0.5,0,0,0,-0.5),
                 BlobEyesVsMarp = c(0,0.5,-0.5,0,0,0,0.5,-0.5,0,0),
                 BlobEyesVsPhid = c(0,0.5,0,-0.5,0,0,0.5,0,-0.5,0),
                 BlobEyesVsShiny = c(0,0.5,0,0,-0.5,0,0.5,0,0,-0.5),
                 MarpVsPhid = c(0,0,0.5,-0.5,0,0,0,0.5,-0.5,0),
                 MarpVsShiny = c(0,0,0.5,0,-0.5,0,0,0.5,0,-0.5),
                 PhidVsShiny = c(0,0,0,0.5,-0.5,0,0,0,0.5,-0.5)),
                 adjust = 'bonferroni')
e <- emmeans(mreac, ~condition, type= "response")
toplotreac <- as.data.frame(e)
```
We now plot the reaction times for all conditions:

```{r plot_reactiontime_exp1}
ggplot(toplotreac, aes(x = condition, y = response))+
geom_point()+
geom_errorbar(aes(ymin = response-SE, ymax = response+SE))
```
Spiders show the longest freezes for Marpissa and Phidippus. Due the likely fewer data points in the Blob (control) condition,
there is quite a big variance in the reaction time. We plot the original data points to better visualize this:

```{r plot_reactiontime_raw_exp1}
ggplot(exp1,aes(condition, reactiontime, fill= condition))+
geom_boxplot()+
  geom_jitter(height = 0, width= 0.3, cex = 2, line = 2, shape=1)+
labs(title = "Reaction time", y= "probability")+
  scale_x_discrete(labels = c("control", "control + eyes", "Marpissa",
                              "Phidippus", "3D model"))+
theme(axis.title.x = element_blank(), axis.text.x = element_text(size=10),
      axis.text.y = element_text(size=10), axis.title.y = element_text(size=10),
      plot.title = element_text(size= 15, face= "bold"), legend.position = "none")
```
As expected, there are only few data points for the control condition. The most interesting observation may be the shorter freezes for the 3D model compared to Marpissa and Phidippus.

## Experiment 2 - blob vs faceless vs shiny

In experiment 2, spiders were tested using 3 different objects (Blob = control, Faceless = 3D model w/o eyes, Shiny = 3D model).

### Preliminary analysis

 All preliminary analyses will use passing as dependent variable as we consider it to be the more robust and objective measure of recognition of the target. We will test all variables against passing regardless of condition. Not sex, because all tests in exp2 were conducted with adult females.

#### Date

```{r model_date_exp2}
mdate2 <- glmmTMB(passing~date + (1|subject), data = exp2, family=binomial)
simres <- simulateResiduals(mdate2)
plot(simres)
Anova(mdate2)
```
Hooray - correct distribution!

#### Passing the target exp2

We calculate the model for the variable passing exactly as for experiment 1.

```{r model_passing_exp2}
mret2 <- glmmTMB(passing ~ condition * test + (1|subject), data= exp2, family= binomial)
```
presumably because the data is completely separated for the conditions blob and shiny (meaning no spider passed Shiny but all passed Blob), the model fails to converge.
We now plot the data to visualize passing for the three conditions in experiment 2.

```{r plot_passing_exp2_plot}
new.labels2 <- c("Blob" = "control", "Faceless" = "3D model w/o eyes", "Shiny" = "3D model")

ggplot(exp2, aes(x=test,y=passing,color=condition))+
facet_grid(~condition, labeller = labeller(condition = new.labels2))+
geom_jitter(width = 0.5, height = 0.02,shape = 1, size=4)+
geom_smooth(method="glm")+
ylim(-0.2,1.2)+
  scale_x_continuous(labels = scales::number_format(accuracy = 1))+
labs(title = "Probability to pass depending on order of presentation", x = "order of presentation", y ="probability", size=12)+
theme(strip.text = element_text(size=10), axis.text.x = element_text(size=10),
      axis.text.y = element_text(size=10), axis.title.x = element_text(size=10),
      axis.title.y = element_text(size=10), plot.title = element_text(size= 15, face= "bold"),
      legend.position = "none")
```

Our hypothesis of data separation in confirmed. We subsequently will not be able to calculate a model for the second experiment based on passing. To get a better idea of the difference between the conditions Faceless and Shiny we will now plot reactiontime for the three conditions of experiment 2. Attention! Reaction time is directly linked to freezes, when there is no freeze, there is no reactiontime, meaning there is no data for the control condition.

#### Freeze duration (reaction time) exp2

```{r plot_reactiontime_exp2}
ggplot(exp2, aes(condition, reactiontime, color= condition))+
geom_boxplot()+
geom_jitter(cex= 2)+
ggtitle("Reaction time")+
  labs(y = "reactiontime (in s)")+
  scale_x_discrete(labels = c("control", "3D model w/o eyes", "3D model"))+
theme(strip.text = element_text(size=10), axis.text.x = element_text(size=10),
      axis.text.y = element_text(size=10), axis.title.x = element_text(size=10),
      axis.title.y = element_text(size=10), plot.title = element_text(size= 15, face= "bold"),
      legend.position = "none")
```
We can see a clear difference of reaction time (freezing time) between the 3D model without eyes and the 3D model. Spiders freeze more than twice as long for the 3D model without eyes, implying that the recognition process is hindered by the lack of eye features.

## Spiderlings

```{r loading_spiderling_data}
spid <- read.csv("C:/Users/roess/Desktop/Publications/PredRecognition/Spiderlings_Innateness/Spiderlings_Boris.csv")
look <- subset(spid, looking == "1")
```

```{r table_spiderlings}
tapply(look$retreat, look$condition, table)
```

```{r plot_retreats}
ggplot(spid, aes(y = retreat, fill = condition))+
  geom_bar(stat = "identity", aes(x = condition), width = .2)+
  ggsave(filename = "spiderlings.svg")
```

```{r mean_freezeduration}
colMeans(spid[sapply(spid, is.numeric)])
mean(spid$reactiontime[!is.na(spid$reactiontime)])
```

```{r test_eggsac}
mmom <- glmmTMB(retreat ~ Mom + (1|subject), data = spid, family = binomial)
Anova(mmom)
```

```{r test_trial}
mtrial <- glmmTMB(retreat ~ trial + (1|subject), data = spid, family = binomial)
Anova(mtrial)
```