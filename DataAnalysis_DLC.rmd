---
title: "Data Analysis - Automated Tracking Data (DLC)"
author: "Daniela C. Rößler, Massimo De Agrò, Kris Kim, Paul S. Shamble"
output: pdf_document
---
# Data analysis - Predator recognition - automated tracking data using DeepLabCut

```{r include = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

## Load packages

```{r packages}
library(car) #for anova
library(glmmTMB) #for mixed models
library(DHARMa) #for residual distribution check
library(ggplot2) #for plotting
library(emmeans) #for post-hoc
library(fitdistrplus) #for data distribution
library(dplyr) #for stats
library(svglite) #create svg files
```

## Load data

```{r loading}
master <- read.csv("-----------/dlcdata.csv")
#create factors
master$trial <- as.factor(master$trial)
master$day <- as.factor(master$day)
master$spiderID <- as.factor(master$spiderID)

#translating passing and jumping into binomial variables
master$pass[master$targetpass == "TRUE"] <- "1"
master$pass[master$targetpass == "FALSE"] <- "0"
master$jumping[master$jump == "TRUE"] <- "1"
master$jumping[master$jump == "FALSE"] <- "0"

#create additional variables
master$pass <- as.numeric(master$pass)
master$jumping <- as.numeric(master$jumping)

#subsets for the experiments
exp1 <- subset(master, master$exp == 1)
exp2 <- subset(master, master$exp == 2)

# as there are zeros in the dataset when spiders did not freeze at all,
# we have to create subsets for both experiments not containing NAs
freeze1 <- subset(exp1, exp1$freezesec > 0)
freeze2 <- subset(exp2, exp2$freezesec > 0)

#new labels for plots
new.labels1 <- c("Blob" = "control", "BlobEyes" = "control + eyes",
                 "Marp" = "Marpissa", "Phid"= "Phidippus", "Shiny" = "3D model")

new.labels2 <- c("Blob" = "control", "Faceless" = "3D model w/o eyes", "Shiny" = "3D model")
```

## Experiment 1 - blob vs blobeyes vs shiny vs marp vs phid
In experiment 1, spiders were tested using 5 different objects (Blob = control, BlobEyes = control + eyes, Marp = Marpissa, Phid = Phidippus, Shiny = 3D model).

### Preliminary analysis

 All preliminary analyses will use passing the object as dependent variable as we consider it to be a robust and objective measure of ultimate decision (whether or not it is safe to pass the object on the other side).
 We are going to test all variables against passing regardless of condition. Yet, we will test the three main variables for any effects of sex in the first experiment (freeze duration, distance change,
 passing).

#### Sex differences


```{r sex_freeze_duration}
msexfre <- glmmTMB(freezesec ~ condition * sex + (1|spiderID), data = freeze1,
                   family= Gamma(link = "log"))
simres <- simulateResiduals(msexfre)
plot(simres)
Anova(msexfre)
```

```{r sex_distance_change}
msexdist <- glmmTMB(distmm ~ condition * sex + (1|spiderID), data = freeze1,
                    family= gaussian(link="identity"))
simres <- simulateResiduals(msexdist)
plot(simres)
Anova(msexdist)
```

```{r sex_passing}
msexpass <- glmmTMB(pass ~ condition * sex + (1|spiderID), data = exp1, family = binomial)
simres <- simulateResiduals(msexpass)
plot(simres)
Anova(msexpass)
```
Since the test is based on the y, we will not repeat the distribution test for every other model that uses passing as dependent variable. There is no difference between the sexes.

#### Day

We are going to check whether there was any effect between the two different test days.

```{r model_day}
mday <- glmmTMB(pass ~ condition * day + (1|spiderID), data=exp1, family = binomial)
Anova(mday)
```

#### Date

We are going to check whether the behavior was balanced over the different dates on which spiders were tested.

```{r model_date}
mdate <- glmmTMB(pass ~ date + (1|spiderID), data=exp1, family = binomial)
Anova(mdate)
summary(mdate)
```
There is a difference between dates, thus we are going to do a post-hoc test.

```{r posthoc_date}
e <- emmeans(mdate, ~date, type= "response")
pairs(e, adjust='bonferroni')
```
It seems like the 23rd of april is different from the 17th and the 21st. We will plot the data to visualize it.

```{r plot_date}
toplotdate <- as.data.frame(e)
ggplot(toplotdate, aes(x=date, y=prob))+
geom_point()+
geom_errorbar(aes(ymin=prob-SE,ymax=prob+SE))+
ylim(0,1)+
ggtitle("Probability of retreating per date")
```
It appears that the difference is significant against day 17th and 21st. The 23rd has a higher percentage of passing in general. It just so happens that days 17 and 21 are the lowest, so that the difference only remains there. In general, this difference should not be concerning, since the conditions are balanced over all dates.

### Main analysis
#### Pass

We are now testing the potential effect of condition and order of object presentation on the probability to pass the object. We use spiderID (subject) as a random factor.

```{r model_pass_exp1}
mpass1 <- glmmTMB(pass ~ condition * test + (1|spiderID), family= binomial, data = exp1)
Anova(mpass1)
```
We see a significant effect of condition on the probability to pass the object. Consequently we will do a post-hoc test.

```{r posthoc_pass_exp1}
e <- emmeans(mpass1,~condition, type = "response")
pairs(e, adjust = 'bonferroni')
```
The lack of significance between Blob and Shiny as well as BlobEyes and Shiny is likely due to the data separation (the fact that spiders not once passed the object in the Shiny condition). To make the comparison clearer, we will now plot the probability for all conditions:

```{r plot_pass_exp1}
toplotpass1 <- as.data.frame(e)
ggplot(toplotpass1, aes(x=condition,y=prob, color= condition))+
  geom_point(cex = 3)+
  geom_errorbar(aes(ymin=prob-SE,ymax=prob+SE), cex = 1, width= 0.8)+
  ylim(0,1)+
  labs(title = "Probability to pass", y= "probability")+
  scale_x_discrete(labels = new.labels1)+
  theme(axis.title.x = element_blank(), axis.text.x = element_text(size=10, angle=45, hjust = 1),
        axis.text.y = element_text(size=10), axis.title.y = element_text(size=10),
        plot.title = element_text(size= 15, face= "bold"), legend.position = "none")+
ggsave(filename= "pass_dlc.svg", width = 8, height = 10)
```
While we did not find a significant effect of the order of presentation in the automated tracking data, we did see an interesting relationship of presentation order for the condition "BlobEyes" (control + eyes) in the hand-scored data. We thus want to look at the relationship here too:

```{r plot_pass_testorder_exp1}
ggplot(exp1, aes(x=test,y=pass, color= condition))+
  facet_grid(~condition, labeller = labeller(condition = new.labels1))+
  geom_jitter(width = 0, height = 0.02,shape = 1, size=2)+
  geom_smooth(method="glm")+
  ylim(-0.2,1.2)+
  labs(title = "Probability to pass depending on order of presentation",
       x= "order of presentation", size= 12, y= "probability", size = 12)+
  theme(strip.text = element_text(size=10), axis.text.x = element_text(size=10),
        axis.text.y = element_text(size=10), axis.title.x = element_text(size=10),
        axis.title.y = element_text(size=10), plot.title = element_text(size= 15, face= "bold"),
        legend.position = "none")+
ggsave(filename = "plot_pass_testorder.svg")
```
Although not significant, we see the same positive relationship between test number and probability of passing in the control + eyes condition. In later trials, spiders are more likely to categorize BlobEyes as non-threatening and pass it at higher frequencies.

#### Freeze duration

Freezing is a proxy of object detection and inspection. We noticed that when detecting an object, spiders freeze until they have made a decision how to react towards the stimulus depending on categorization (threatening or non-threatening). Using the longest freeze in each trial, we can compare how long each object is visually inspected until a decision for the behavioral response is made. Freezing is defined as zero velocity while looking at the target (defined as a 10degree sightline cone that must touch the outline of the object in order for the spider to be looking at it).

First, let's have a look at the original (raw) data:

```{r plot_raw_freeze_exp1}
ggplot(aes(x = condition, y = freezesec, fill = condition), data = exp1)+
  geom_boxplot()+
  ylim(0,40)+
  labs(title = "Freezing time per condition", size= 12, y= "freezing time (in seconds)", size = 12)+
   theme(axis.title.x = element_blank(), axis.text.x = element_text(size=10, angle=45, hjust = 1),
        axis.text.y = element_text(size=10), axis.title.y = element_text(size=10),
        plot.title = element_text(size= 15, face= "bold"), legend.position = "none")+
scale_x_discrete(labels = new.labels1)+
ggsave(filename= "freezing_exp1_dlc.svg", width = 8, height = 10)
```
There seem to be clear differences in freezing time, thus, we will run a model, which will contain:

+ freezing time (freezewindow (in seconds))
* condition
* test, which indicates the order in which the objects are presented within an experiment

First, we have to identify the correct distribution.

```{r distr_check_freeze}
plotdist(exp1$freezesec[!is.na(exp1$freezesec)], histo = TRUE, demp = TRUE)
descdist(exp1$freezesec[!is.na(exp1$freezesec)], boot = 1000)
```

```{r model_freeze_exp1}
mfre1 <-glmmTMB(freezesec ~ condition * test + (1|spiderID), data = freeze1,
                family= Gamma(link = "log"))
simres <- simulateResiduals(mfre1)
plot(simres)
Anova(mfre1)
```

The distribution is okay! There is a strong effect of condition, meaning that spiders freeze differently for different objects.
There is also an effect of the order of presentation, meaning that the freezing time changes with time (or presentation order) but only for one or some conditions; To better see the effect, we will do a post-hoc test to see the differences between conditions. The post-hoc test will not contain presentation order since it is a continuous variable and cannot be inserted in estimated mean analysis.

```{r posthoc_freeze_exp1}
e <- emmeans(mfre1,~condition, type = "response")
pairs(e, adjust = 'bonferroni')
```
The observed lack of significance between Marp and Phid as well as between Marp and Shiny can most likely be ascribed to the high variability of freezing times in the Marp condition. We will plot the data to get a better sense:


```{r plot_freeze_exp1}
toplotfre1 <- as.data.frame(e)
ggplot(toplotfre1, aes(x=condition,y=response, color= condition))+
geom_point(cex = 3)+
geom_errorbar(aes(ymin = response-SE, ymax = response + SE), cex = 1, width= 0.8)+
  labs(title = "Freezing time per condition",
       x= "condition", size= 12, y= "freezing time (in seconds)", size = 12)+
theme(axis.title.x = element_blank(), axis.text.x = element_text(size=10, angle=45, hjust = 1),
        axis.text.y = element_text(size=10), axis.title.y = element_text(size=10),
        plot.title = element_text(size= 15, face= "bold"), legend.position = "none")+
scale_x_discrete(labels = new.labels1)+
ggsave(filename = "model_freezing_exp1.svg")
```
We see the longest freezes happen for Phidippus, followed by Marpissa. Spiders only freeze shortly for the control, however twice as long for the control + eyes. It is interesting that freezes for Shiny are shorter than towards the "real" spider objects, implying a fast recognition, or at least decision, process.

#### Retreat

The retreat in the automated data is defined as the behavior that occurs within 2 s (120 frames) after the longest observed freeze in each trial. This behavior is described in the position of the spider, thus, whether the spider increases or decreases the distance from the object after having inspected it.

First, we will plot this distance change occurring 2 seconds after the end of the freeze (max 120 frames, or shorter if retreat/trial/tracking ends before the 120 frames).

```{r plot_retreat_raw_exp1}
ggplot(aes(x = condition, y = distmm, fill = condition), data = exp1)+
  geom_boxplot()+
  labs(title = "Distance change after freezing",
       x= "condition", size= 12, y= "distance change from object (in mm)", size = 12)+
   theme(axis.title.x = element_blank(), axis.text.x = element_text(size=10, angle=45, hjust = 1),
        axis.text.y = element_text(size=10), axis.title.y = element_text(size=10),
        plot.title = element_text(size= 15, face= "bold"), legend.position = "none")+
scale_x_discrete(labels = new.labels1)+
ggsave(filename = "distance_raw_exp1.svg", width = 8, height = 10)
```
We can clearly see that for both Blob and BlobEyes, spiders on average decrease their distance to the object after freezing, thus getting closer to the object. However, clearly more so in the Blob condition. For all "spider-like" objects, we can clearly see that on average the spider increased their distance from the object 2 seconds after object inspection. We will now run a model to see whether these differences are significant:

```{r model_retreat_exp1}
mret1 <- glmmTMB(distmm ~ condition + (1|spiderID), data=exp1, family= gaussian(link="identity"))
simres <- simulateResiduals(mret1)
plot(simres)
Anova(mret1)
```
The distribution is not perfect, but ok. Condition has a significant effect on the distance change. We follow up with a post-hoc test.

```{r posthoc_retreat_exp1}
e <- emmeans(mret1, ~condition, type="response")
pairs(e, adjust= "bonferroni")
```
All contrasts except for Shiny and Phid are significant, which may represent their inherent similarity. We will now plot the model results:

```{r}
toplotret1 <- as.data.frame(e)
ggplot(toplotret1, aes(x=condition,y= emmean, color= condition))+
geom_point(cex = 3)+
  ylim(-20,15)+
geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), cex = 1, width = 0.8)+
  labs(title = "Distance change after freezing",
       x= "condition", size= 12, y= "distance change from object (in mm)", size = 12)+
   theme(axis.title.x = element_blank(), axis.text.x = element_text(size=10, angle=45, hjust = 1),
        axis.text.y = element_text(size=10), axis.title.y = element_text(size=10),
        plot.title = element_text(size= 15, face= "bold"), legend.position = "none")+
scale_x_discrete(labels = new.labels1)+
ggsave(filename = "distance_exp1.svg", width = 8, height = 10)
```
We now see the average responses in retreat distance change for every condition, confirming the observations from the original data.

## Experiment 2 - blob vs faceless vs shiny
In experiment 2, spiders were tested using 3 different objects (Blob = control, Faceless = 3D model w/o eyes, Shiny = 3D model).

### Preliminary analysis
#### Date

Again, we check whether date had an influence on the observed trials. To do this, we use the robust "pass" variable again. We don't have to check for sex differences again, as in the second experiment we only used new adult female spiders.

```{r model_date_exp2}
mdate2 <- glmmTMB(pass~date + (1|spiderID), data = exp2, family=binomial)
simres <- simulateResiduals(mdate2)
plot(simres)
Anova(mdate2)
```
The distribution is correct and we find no significant effect of date.

### Main analysis
#### Pass

We analyze the data for exp. 2 in the same way as in experiment 1.

```{r model_pass_exp2}
mpass2 <- glmmTMB(pass ~ condition * test + (1|spiderID), family= binomial, data = exp2)
Anova(mpass2)
```
We see a significant effect of condition, thus a post-hoc analysis:

```{r posthoc_pass_exp2}
e <- emmeans(mpass2,~condition, type = "response")
pairs(e, adjust = 'bonferroni')
```
As Shiny, again, entails not a single spider passing the object, we see a complete separation of data making it impossible to show significance for the difference between Blob and Shiny. We will plot the probability to pass the objects in experiment 2 to have a better understanding:

```{r plot_pass_exp2}
toplotpass2 <- as.data.frame(e)
ggplot(toplotpass2, aes(x=condition,y=prob, color= condition))+
  geom_point(cex = 3)+
  geom_errorbar(aes(ymin=prob-SE,ymax=prob+SE), cex = 1, width= .8)+
  ylim(0,1.1)+
  labs(title = "Probability to pass", y= "probability")+
  theme(axis.title.x = element_blank(), axis.text.x = element_text(size=10, angle=45, hjust = 1),
        axis.text.y = element_text(size=10), axis.title.y = element_text(size=10),
        plot.title = element_text(size= 15, face= "bold"), legend.position = "none")+
scale_x_discrete(labels = new.labels2)
```
In the ultimate decision, we clearly see that spiders categorize the 3D model without eyes as threatening and do not pass it. Out of curiosity due to earlier analyses we want to see how testorder affects the decision-making for the objects in experiment 2

```{r plot_pass_testorder_exp2}
ggplot(exp2, aes(x=test,y=pass, color= condition))+
  facet_grid(~condition, labeller = labeller(condition = new.labels2))+
  geom_jitter(width = 0, height = 0.02,shape = 1, size=2)+
  geom_smooth(method="glm")+
  ylim(-0.2,1.2)+
  labs(title = "Probability to pass depending on order of presentation",
       x= "order of presentation", size= 12, y= "probability", size = 12)+
  theme(strip.text = element_text(size=10), axis.text.x = element_text(size=10),
        axis.text.y = element_text(size=10), axis.title.x = element_text(size=10),
        axis.title.y = element_text(size=10), plot.title = element_text(size= 15, face= "bold"),
        legend.position = "none")
```
Interestingly, with more trials, the 3D model without eyes becomes "more threatening". This is an interesting observation worth discussing together with the reverse effect for BlobEyes in experiment 1.

#### Freeze duration

While passing made the difference between the 3D model and the 3D model without eyes appear minor, we want to have a look at the freezing time for the three conditions. Freezing is a proxy for reaction time, meaning the time from the the object detection until the ultimate behavioral response following a decision. We use this as a proxy of ease of recognition and potential certainty about object identity.

First, we plot the original data:

```{r plot_raw_freeze_exp2}
ggplot(aes(x = condition, y = freezesec, fill = condition), data = exp2)+
  geom_boxplot()+
  labs(title = "Freezing time per condition",
       x= "condition", size= 12, y= "freezing time (in seconds)", size = 12)+
theme(axis.title.x = element_blank(), axis.text.x = element_text(size=10, angle=45, hjust = 1),
        axis.text.y = element_text(size=10), axis.title.y = element_text(size=10),
        plot.title = element_text(size= 15, face= "bold"), legend.position = "none")+
scale_x_discrete(labels = new.labels2)+
ggsave(filename = "freezing_raw_exp2.svg", width = 5, height = 10)


```
We can see a clear difference between the freezing times for the three objects, thus we will run a model:

```{r model_freeze_exp2}
mfre2 <-glmmTMB(freezesec ~ condition * test + (1|spiderID), data = freeze2,
                family= Gamma(link = "log"))
simres <- simulateResiduals(mfre2)
plot(simres)
Anova(mfre2)
```
The distribution is correct. We see a significant effect of condition on the freezing time, so we will do a post-hoc analysis:

```{r posthoc_freeze_exp2}
e <- emmeans(mfre2,~condition, type = "response")
pairs(e, adjust = 'bonferroni')
```
All contrasts are significant, so we will plot the results:

```{r plot_freeze_exp2}
toplotfre2 <- as.data.frame(e)
ggplot(toplotfre2, aes(x=condition,y=response, color= condition))+
geom_point(cex = 3)+
geom_errorbar(aes(ymin = response-SE, ymax = response + SE), cex = 1, width = 0.8)+
    labs(title = "Freezing time per condition", y = "freezing time (in seconds)")+
  theme(axis.title.x = element_blank(), axis.text.x = element_text(size=10, angle=45, hjust = 1),
        axis.text.y = element_text(size=10), axis.title.y = element_text(size=10),
        plot.title = element_text(size= 15, face= "bold"), legend.position = "none")+
scale_x_discrete(labels = new.labels2)+
ggsave(filename = "freezing_exp2.svg")
```
We see that the faceless condition (3D model without eyes), has a significantly longer freezing time than for the Blob and the Shiny condition. This indicates that the lack of eyes influences the ease and speed at which recognition happens in this condition.

### Retreat

As in experiment 1, we want to see how the spider moves after the inspection. For that reason, we first plot the original data:

```{r plot_retreat_raw_exp2}
ggplot(aes(x = condition, y = distmm, fill = condition), data = exp2)+
  geom_boxplot()+
    labs(title = "Distance change after freezing", y = "distance change from object (in mm)")+
theme(axis.title.x = element_blank(), axis.text.x = element_text(size=10, angle=45, hjust = 1),
        axis.text.y = element_text(size=10), axis.title.y = element_text(size=10),
        plot.title = element_text(size= 15, face= "bold"), legend.position = "none")+
scale_x_discrete(labels = new.labels2)+
ggsave(filename = "dist_raw_exp2.svg", width = 5, height = 10)
```
We clearly see that for Blob, spiders move far towards (or passed) the object, while they move away for the 3D model and the 3D model without eyes. It is apparent, however, that the distance increase is higher for the 3D model. Thus, we will run a model to see if it is significant:

```{r model_retreat_exp2}
mret2 <- glmmTMB(distmm ~ condition + (1|spiderID), data=exp2, family= gaussian)
simres <- simulateResiduals(mret2)
plot(simres)
Anova(mret2)
```
The distribution is correct. The distance change differs significantly between condition, so we will do a post-hoc analysis:

```{r posthoc_retreat_exp2}
e <- emmeans(mret2, ~condition, type="response")
pairs(e, adjust= "bonferroni")
```
All contrasts are significant! We will plot the model results

```{r plot_retreat_exp2}
toplotret2 <- as.data.frame(e)
ggplot(toplotret2, aes(x=condition,y=emmean, color= condition))+
geom_point()+
geom_errorbar(aes(ymin = emmean-SE, ymax = emmean + SE))+
   labs(title = "Distance change after freezing", y = "distance change from object (in mm)")+
  theme(axis.title.x = element_blank(), axis.text.x = element_text(size=10, angle=45, hjust = 1),
        axis.text.y = element_text(size=10), axis.title.y = element_text(size=10),
        plot.title = element_text(size= 15, face= "bold"), legend.position = "none")+
scale_x_discrete(labels = new.labels2)+
  ggsave(filename = "dist_exp2.svg")
```
We can see clearly, that spiders approach the control after inspection of the object, while they increase their distance from both 3D models. However, significantly less so for the 3D model without eyes.

